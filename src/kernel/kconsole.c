#include "kconsole.h"

// ============================================================================
// 8×8 bitmap font (IBM PC / VGA BIOS compatible, ASCII 0x00–0x7F)
// Each entry = 8 bytes, one per row, MSB = leftmost pixel
// ============================================================================
static const u8 font8x8[128][8] = {
    /* 0x00 */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 0x01 */ {0x7E,0x81,0xA5,0x81,0xBD,0x99,0x81,0x7E},
    /* 0x02 */ {0x7E,0xFF,0xDB,0xFF,0xC3,0xE7,0xFF,0x7E},
    /* 0x03 */ {0x6C,0xFE,0xFE,0xFE,0x7C,0x38,0x10,0x00},
    /* 0x04 */ {0x10,0x38,0x7C,0xFE,0x7C,0x38,0x10,0x00},
    /* 0x05 */ {0x38,0x7C,0x38,0xFE,0xFE,0x10,0x10,0x7C},
    /* 0x06 */ {0x10,0x10,0x38,0x7C,0xFE,0x7C,0x10,0x7C},
    /* 0x07 */ {0x00,0x00,0x18,0x3C,0x3C,0x18,0x00,0x00},
    /* 0x08 */ {0xFF,0xFF,0xE7,0xC3,0xC3,0xE7,0xFF,0xFF},
    /* 0x09 */ {0x00,0x3C,0x66,0x42,0x42,0x66,0x3C,0x00},
    /* 0x0A */ {0xFF,0xC3,0x99,0xBD,0xBD,0x99,0xC3,0xFF},
    /* 0x0B */ {0x0F,0x07,0x0F,0x7D,0xCC,0xCC,0xCC,0x78},
    /* 0x0C */ {0x3C,0x66,0x66,0x66,0x3C,0x18,0x7E,0x18},
    /* 0x0D */ {0x3F,0x33,0x3F,0x30,0x30,0x70,0xF0,0xE0},
    /* 0x0E */ {0x7F,0x63,0x7F,0x63,0x63,0x67,0xE6,0xC0},
    /* 0x0F */ {0x99,0x5A,0x3C,0xE7,0xE7,0x3C,0x5A,0x99},
    /* 0x10 */ {0x80,0xE0,0xF8,0xFE,0xF8,0xE0,0x80,0x00},
    /* 0x11 */ {0x02,0x0E,0x3E,0xFE,0x3E,0x0E,0x02,0x00},
    /* 0x12 */ {0x18,0x3C,0x7E,0x18,0x18,0x7E,0x3C,0x18},
    /* 0x13 */ {0x66,0x66,0x66,0x66,0x66,0x00,0x66,0x00},
    /* 0x14 */ {0x7F,0xDB,0xDB,0x7B,0x1B,0x1B,0x1B,0x00},
    /* 0x15 */ {0x3E,0x63,0x38,0x6C,0x6C,0x38,0xCC,0x78},
    /* 0x16 */ {0x00,0x00,0x00,0x00,0x7E,0x7E,0x7E,0x00},
    /* 0x17 */ {0x18,0x3C,0x7E,0x18,0x7E,0x3C,0x18,0xFF},
    /* 0x18 */ {0x18,0x3C,0x7E,0x18,0x18,0x18,0x18,0x00},
    /* 0x19 */ {0x18,0x18,0x18,0x18,0x7E,0x3C,0x18,0x00},
    /* 0x1A */ {0x00,0x18,0x0C,0xFE,0x0C,0x18,0x00,0x00},
    /* 0x1B */ {0x00,0x30,0x60,0xFE,0x60,0x30,0x00,0x00},
    /* 0x1C */ {0x00,0x00,0xC0,0xC0,0xC0,0xFE,0x00,0x00},
    /* 0x1D */ {0x00,0x24,0x66,0xFF,0x66,0x24,0x00,0x00},
    /* 0x1E */ {0x00,0x18,0x3C,0x7E,0xFF,0xFF,0x00,0x00},
    /* 0x1F */ {0x00,0xFF,0xFF,0x7E,0x3C,0x18,0x00,0x00},
    /* ' ' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* '!' */ {0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00},
    /* '"' */ {0x6C,0x6C,0x48,0x00,0x00,0x00,0x00,0x00},
    /* '#' */ {0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00},
    /* '$' */ {0x18,0x7E,0xD8,0x7C,0x1B,0x7E,0x18,0x00},
    /* '%' */ {0x00,0x66,0x6C,0x18,0x30,0x66,0x06,0x00},
    /* '&' */ {0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00},
    /* '\''*/ {0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00},
    /* '(' */ {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00},
    /* ')' */ {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00},
    /* '*' */ {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00},
    /* '+' */ {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00},
    /* ',' */ {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30},
    /* '-' */ {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00},
    /* '.' */ {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00},
    /* '/' */ {0x06,0x0C,0x0C,0x18,0x30,0x60,0x60,0x00},
    /* '0' */ {0x3C,0x66,0x6E,0x76,0x66,0x66,0x3C,0x00},
    /* '1' */ {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00},
    /* '2' */ {0x3C,0x66,0x06,0x0C,0x18,0x30,0x7E,0x00},
    /* '3' */ {0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00},
    /* '4' */ {0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0x00},
    /* '5' */ {0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00},
    /* '6' */ {0x1C,0x30,0x60,0x7C,0x66,0x66,0x3C,0x00},
    /* '7' */ {0x7E,0x06,0x0C,0x18,0x18,0x30,0x30,0x00},
    /* '8' */ {0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00},
    /* '9' */ {0x3C,0x66,0x66,0x3E,0x06,0x0C,0x38,0x00},
    /* ':' */ {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00},
    /* ';' */ {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x30},
    /* '<' */ {0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x00},
    /* '=' */ {0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00},
    /* '>' */ {0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x00},
    /* '?' */ {0x3C,0x66,0x06,0x0C,0x18,0x00,0x18,0x00},
    /* '@' */ {0x3C,0x62,0x6E,0x6E,0x66,0x40,0x3C,0x00},
    /* 'A' */ {0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00},
    /* 'B' */ {0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00},
    /* 'C' */ {0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00},
    /* 'D' */ {0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00},
    /* 'E' */ {0x7E,0x60,0x60,0x7C,0x60,0x60,0x7E,0x00},
    /* 'F' */ {0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0x00},
    /* 'G' */ {0x3C,0x66,0x60,0x6E,0x66,0x66,0x3E,0x00},
    /* 'H' */ {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00},
    /* 'I' */ {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    /* 'J' */ {0x1E,0x0C,0x0C,0x0C,0x0C,0x6C,0x38,0x00},
    /* 'K' */ {0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00},
    /* 'L' */ {0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00},
    /* 'M' */ {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00},
    /* 'N' */ {0x66,0x76,0x7E,0x6E,0x6E,0x66,0x66,0x00},
    /* 'O' */ {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00},
    /* 'P' */ {0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00},
    /* 'Q' */ {0x3C,0x66,0x66,0x66,0x76,0x6C,0x36,0x00},
    /* 'R' */ {0x7C,0x66,0x66,0x7C,0x6C,0x66,0x66,0x00},
    /* 'S' */ {0x3C,0x66,0x60,0x3C,0x06,0x66,0x3C,0x00},
    /* 'T' */ {0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00},
    /* 'U' */ {0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00},
    /* 'V' */ {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00},
    /* 'W' */ {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00},
    /* 'X' */ {0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00},
    /* 'Y' */ {0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x00},
    /* 'Z' */ {0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00},
    /* '[' */ {0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00},
    /* '\\'*/ {0x60,0x30,0x18,0x18,0x0C,0x06,0x06,0x00},
    /* ']' */ {0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00},
    /* '^' */ {0x18,0x3C,0x66,0x00,0x00,0x00,0x00,0x00},
    /* '_' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
    /* '`' */ {0x18,0x18,0x0C,0x00,0x00,0x00,0x00,0x00},
    /* 'a' */ {0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00},
    /* 'b' */ {0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00},
    /* 'c' */ {0x00,0x00,0x3C,0x66,0x60,0x66,0x3C,0x00},
    /* 'd' */ {0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00},
    /* 'e' */ {0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00},
    /* 'f' */ {0x1C,0x30,0x30,0x7C,0x30,0x30,0x30,0x00},
    /* 'g' */ {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x3C},
    /* 'h' */ {0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x00},
    /* 'i' */ {0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00},
    /* 'j' */ {0x06,0x00,0x0E,0x06,0x06,0x66,0x3C,0x00},
    /* 'k' */ {0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00},
    /* 'l' */ {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    /* 'm' */ {0x00,0x00,0x66,0x7F,0x6B,0x63,0x63,0x00},
    /* 'n' */ {0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00},
    /* 'o' */ {0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00},
    /* 'p' */ {0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60},
    /* 'q' */ {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06},
    /* 'r' */ {0x00,0x00,0x6C,0x76,0x60,0x60,0x60,0x00},
    /* 's' */ {0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00},
    /* 't' */ {0x18,0x18,0x7E,0x18,0x18,0x18,0x0E,0x00},
    /* 'u' */ {0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00},
    /* 'v' */ {0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00},
    /* 'w' */ {0x00,0x00,0x63,0x6B,0x7F,0x36,0x36,0x00},
    /* 'x' */ {0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00},
    /* 'y' */ {0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x3C},
    /* 'z' */ {0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00},
    /* '{' */ {0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00},
    /* '|' */ {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00},
    /* '}' */ {0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00},
    /* '~' */ {0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00},
    /* DEL */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};

// ============================================================================
// Console state
// ============================================================================

#define FONT_W  8
#define FONT_H  9    // 8 glyph rows + 1 blank row spacing

static volatile u32 *fb_addr;
static u32  fb_width;
static u32  fb_height;
static u32  fb_pitch_u32;   // pitch in 32-bit words
static u32  fb_cols;
static u32  fb_rows;
static u32  cur_col;
static u32  cur_row;
static u32  fg_color     = 0xE0E0E0;
static u32  bg_color     = 0x1A1A2E;
static u32  fg_default   = 0xE0E0E0;
static u32  bg_default   = 0x1A1A2E;
static u8   fb_ready     = 0;

/* ANSI escape parser state */
#define ESC_NONE    0
#define ESC_ESC     1
#define ESC_BRACKET 2
static u8  esc_state = ESC_NONE;
static u32 esc_params[8];
static u8  esc_nparam;

/* Standard 4-bit ANSI colour palette (normal + bright) */
static const u32 ansi_palette[16] = {
    0x1A1A2E, 0xCC3333, 0x33AA33, 0xCCAA33,   /* 0-3: dark  */
    0x3355CC, 0xAA33AA, 0x33AACC, 0xCCCCCC,   /* 4-7        */
    0x555555, 0xFF5555, 0x55FF55, 0xFFFF55,   /* 8-11: bright */
    0x5588FF, 0xFF55FF, 0x55FFFF, 0xFFFFFF,   /* 12-15      */
};

static void fb_apply_sgr(void) {
    if (esc_nparam == 0) { esc_params[0] = 0; esc_nparam = 1; }
    for (u8 i = 0; i < esc_nparam; i++) {
        u32 p = esc_params[i];
        if (p == 0) {
            fg_color = fg_default;
            bg_color = bg_default;
        } else if (p == 1) {
            /* bold: brighten fg if it's a standard colour (bits 0-7) */
            for (int j = 0; j < 8; j++)
                if (fg_color == ansi_palette[j]) { fg_color = ansi_palette[j + 8]; break; }
        } else if (p >= 30 && p <= 37) {
            fg_color = ansi_palette[p - 30];
        } else if (p >= 90 && p <= 97) {
            fg_color = ansi_palette[p - 90 + 8];
        } else if (p >= 40 && p <= 47) {
            bg_color = ansi_palette[p - 40];
        } else if (p >= 100 && p <= 107) {
            bg_color = ansi_palette[p - 100 + 8];
        }
    }
}


static void fb_draw_glyph(u32 col, u32 row, u8 ch) {
    const u8 *glyph = font8x8[ch & 0x7F];
    u32 px = col * FONT_W;
    u32 py = row * FONT_H;

    for (u32 y = 0; y < 8; y++) {
        u32 base = (py + y) * fb_pitch_u32 + px;
        u8 bits = glyph[y];
        for (u32 x = 0; x < 8; x++) {
            fb_addr[base + x] = (bits & (0x80 >> x)) ? fg_color : bg_color;
        }
    }
    // Blank spacing row
    u32 base = (py + 8) * fb_pitch_u32 + px;
    for (u32 x = 0; x < 8; x++)
        fb_addr[base + x] = bg_color;
}

static void fb_scroll(void) {
    // Move all rows up by one
    for (u32 r = 1; r < fb_rows; r++) {
        for (u32 y = 0; y < FONT_H; y++) {
            u32 dst = ((r - 1) * FONT_H + y) * fb_pitch_u32;
            u32 src =  (r      * FONT_H + y) * fb_pitch_u32;
            for (u32 x = 0; x < fb_cols * FONT_W; x++)
                fb_addr[dst + x] = fb_addr[src + x];
        }
    }
    // Clear last row
    u32 last_y = (fb_rows - 1) * FONT_H;
    for (u32 y = 0; y < FONT_H; y++) {
        u32 base = (last_y + y) * fb_pitch_u32;
        for (u32 x = 0; x < fb_cols * FONT_W; x++)
            fb_addr[base + x] = bg_color;
    }
}

// ============================================================================
// Public API
// ============================================================================

void kconsole_init(struct limine_framebuffer *fb) {
    fb_addr      = (volatile u32 *)fb->address;
    fb_width     = (u32)fb->width;
    fb_height    = (u32)fb->height;
    fb_pitch_u32 = (u32)(fb->pitch / 4);  // bytes → u32 words
    fb_cols      = fb_width  / FONT_W;
    fb_rows      = fb_height / FONT_H;
    cur_col      = 0;
    cur_row      = 0;
    fb_ready     = 1;

    kconsole_clear();
}

void kconsole_clear(void) {
    if (!fb_ready) return;
    for (u32 y = 0; y < fb_height; y++) {
        u32 base = y * fb_pitch_u32;
        for (u32 x = 0; x < fb_width; x++)
            fb_addr[base + x] = bg_color;
    }
    cur_col = cur_row = 0;
}

void kconsole_putc(char c) {
    if (!fb_ready) return;

    /* ---- ANSI escape sequence state machine ---- */
    if (esc_state == ESC_ESC) {
        if (c == '[') { esc_state = ESC_BRACKET; esc_nparam = 0; esc_params[0] = 0; }
        else           esc_state = ESC_NONE;
        return;
    }
    if (esc_state == ESC_BRACKET) {
        if (c >= '0' && c <= '9') {
            esc_params[esc_nparam] = esc_params[esc_nparam] * 10 + (u32)(c - '0');
        } else if (c == ';') {
            if (esc_nparam < 7) esc_nparam++;
            esc_params[esc_nparam] = 0;
        } else {
            esc_nparam++;   /* count the last param */
            if (c == 'm') fb_apply_sgr();
            /* other final bytes (A/B/C/D cursor moves etc) silently dropped */
            esc_state = ESC_NONE;
        }
        return;
    }
    if ((u8)c == 0x1B) { esc_state = ESC_ESC; return; }

    if (c == '\r') { cur_col = 0; return; }

    if (c == '\n') {
        cur_col = 0;
        cur_row++;
        if (cur_row >= fb_rows) { fb_scroll(); cur_row = fb_rows - 1; }
        return;
    }

    if (c == '\b') {
        if (cur_col > 0) { cur_col--; fb_draw_glyph(cur_col, cur_row, ' '); }
        return;
    }

    if (c < 0x20 || c > 0x7E) return;  /* skip other non-printable */

    fb_draw_glyph(cur_col, cur_row, (u8)c);
    cur_col++;

    if (cur_col >= fb_cols) {
        cur_col = 0;
        cur_row++;
        if (cur_row >= fb_rows) { fb_scroll(); cur_row = fb_rows - 1; }
    }
}

void kconsole_get_info(u32 *width, u32 *height, u32 *pitch_bytes, u32 *bpp)
{
    if (width)       *width       = fb_width;
    if (height)      *height      = fb_height;
    if (pitch_bytes) *pitch_bytes = fb_pitch_u32 * 4;
    if (bpp)         *bpp         = 32;
}

void *kconsole_get_addr(void) { return (void *)fb_addr; }

u64 kconsole_get_size(void) { return (u64)fb_height * fb_pitch_u32 * 4; }
